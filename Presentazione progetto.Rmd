---
title: "Euro 2020"
subtitle: "Cosa c'è dietro al risultato?"
author: "Marco Gherbezza"
output:
  ioslides_presentation:
    widescreen: true
---

<!--# Inizio caricando le librerie che mi serviranno per il programma -->

```{r Carico librerie, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggtext)
library(ggrepel)
library(ggcharts)
library(ggfortify)
library(ggthemes)
library(extrafont)
library(grid)
library(gridExtra)
library(scatterplot3d)
library(hrbrthemes)
```

<!--# Carico il dataset e gli do un occhiata con la funzione head() -->

```{r Carico dataset, include=FALSE}
df <- read_delim("https://raw.githubusercontent.com/MarcoGherby/Progetto-di-Data-Science/main/Database_Euro2020.csv")
head(df)
```

<!--# Do una sistemata ad alcune feature -->

```{r Modifico alcune feature, include=FALSE}
df$TiriPerPartita  <- as.numeric(as.character(df$TiriPerPartita ))
df <- df %>%                        
  mutate(GiocatoriACasa = (Nazionalità == Nazionecampionato))
df <- df %>%                        
  mutate(GiocatoriAllEstero = (Nazionalità != Nazionecampionato))
df <- df %>%
  mutate(GoalSubiti = GoalConcessiPerPartita * PartiteGiocate)
df$GoalSubiti <- floor(df$GoalSubiti)
```

<!--# Creo un dataframe in cui mantengo solamente i giocatori che hanno almeno una media 15 minuti giocati. -->

```{r Creo altri dataframe, include=FALSE}
starts <- subset(df, select = -c(NomeCognome, Ruolo, Campionato, Nazionecampionato, Squadra), MinutiAPartita > 15,)
```

## 3 possibili spunti {.flexbox .vcenter}

-   Il possesso palla è essenziale?
-   Chi ha creato di più ha anche raccolto di più?
-   Portiere più determinante?

<!--# Creo un dataset contenente la media di una feature del dataframe in modo da poter comporre un nuovo dataframe contenente i dati medi di ogni feature per ogni nazionale in modo da poter esplorare ed analizzare le nazionali come rosa nel complesso -->

```{r Creo le feature per il dataframe delle nazionali, warning=FALSE, include=FALSE}
age <- summarise_at(group_by(starts,Nazionalità),vars(Anni),funs(mean(.,na.rm=TRUE)))
age1 <- summarise_at(group_by(starts,Nazionalità),vars(Anni),funs(mean(.,na.rm=TRUE)))
height <- summarise_at(group_by(starts,Nazionalità),vars(Altezza),funs(mean(.,na.rm=TRUE)))
homeplayer <- summarise_at(group_by(starts,Nazionalità),vars(GiocatoriACasa),funs(sum(.,na.rm=TRUE)))
awayplayer <- summarise_at(group_by(starts,Nazionalità),vars(GiocatoriAllEstero),funs(sum(.,na.rm=TRUE)))
ranking <- summarise_at(group_by(starts,Nazionalità),vars(PartiteGiocate),funs(max(.,na.rm=TRUE)))
goalscored <- summarise_at(group_by(starts,Nazionalità),vars(GoalFatti),funs(sum(.,na.rm=TRUE)))
goalconceded <- summarise_at(group_by(starts,Nazionalità),vars(GoalSubiti),funs(sum(.,na.rm=TRUE)))
assistmade <- summarise_at(group_by(starts,Nazionalità),vars(AssistFatti),funs(sum(.,na.rm=TRUE)))
shootspm <- summarise_at(group_by(starts,Nazionalità),vars(TiriPerPartita),funs(sum(.,na.rm=TRUE)))
cfailed <- summarise_at(group_by(starts,Nazionalità),vars(GrandiOccasioniSbagliate),funs(sum(.,na.rm=TRUE)))
touches <- summarise_at(group_by(starts,Nazionalità),vars(PalloniToccatiPerPartita),funs(sum(.,na.rm=TRUE)))
ccreated <- summarise_at(group_by(starts,Nazionalità),vars(OccasioniChiaveCreate),funs(sum(.,na.rm=TRUE)))
percpasstot <- summarise_at(group_by(starts,Nazionalità),vars(PrecisionePassaggi),funs(mean(.,na.rm=TRUE)))
percpassfr <- summarise_at(group_by(starts,Nazionalità),vars(PrecisionePassaggiCampoAmico),funs(mean(.,na.rm=TRUE)))
percpassen <- summarise_at(group_by(starts,Nazionalità),vars(PrecisionePassaggiCampoAvversario),funs(mean(.,na.rm=TRUE)))
intercpm <- summarise_at(group_by(starts,Nazionalità),vars(IntercettazioniAPartita),funs(sum(.,na.rm=TRUE)))
contrpm <- summarise_at(group_by(starts,Nazionalità),vars(ContrastiAPartita),funs(sum(.,na.rm=TRUE)))
dribpm <- summarise_at(group_by(starts,Nazionalità),vars(DribblingRiuscitiPerPartita),funs(sum(.,na.rm=TRUE)))
duelspm <- summarise_at(group_by(starts,Nazionalità),vars(DuelliVintiAPartita),funs(sum(.,na.rm=TRUE)))
balllose <- summarise_at(group_by(starts,Nazionalità),vars(PalloniPersiAPartita),funs(sum(.,na.rm=TRUE)))
fauls <- summarise_at(group_by(starts,Nazionalità),vars(FalliPerPartita),funs(sum(.,na.rm=TRUE)))
```

```{r Creo dataframe per dataframe ruoli, include=FALSE}
Rage <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(Anni),funs(mean(.,na.rm=TRUE)))
Rheight <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(Altezza),funs(mean(.,na.rm=TRUE)))
Rhomeplayer <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(GiocatoriACasa),funs(sum(.,na.rm=TRUE)))
Rawayplayer <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(GiocatoriAllEstero),funs(sum(.,na.rm=TRUE)))
Rranking <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PartiteGiocate),funs(max(.,na.rm=TRUE)))
Rgoalscored <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(GoalFatti),funs(sum(.,na.rm=TRUE)))
Rgoalconceded <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(GoalSubiti),funs(sum(.,na.rm=TRUE)))
Rassistmade <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(AssistFatti),funs(sum(.,na.rm=TRUE)))
Rshootspm <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(TiriPerPartita),funs(sum(.,na.rm=TRUE)))
Rcfailed <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(GrandiOccasioniSbagliate),funs(sum(.,na.rm=TRUE)))
Rtouches <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PalloniToccatiPerPartita),funs(sum(.,na.rm=TRUE)))
Rccreated <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(OccasioniChiaveCreate),funs(sum(.,na.rm=TRUE)))
Rpercpasstot <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PrecisionePassaggi),funs(mean(.,na.rm=TRUE)))
Rpercpassfr <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PrecisionePassaggiCampoAmico),funs(mean(.,na.rm=TRUE)))
Rpercpassen <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PrecisionePassaggiCampoAvversario),funs(mean(.,na.rm=TRUE)))
Rintercpm <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(IntercettazioniAPartita),funs(sum(.,na.rm=TRUE)))
Rcontrpm <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(ContrastiAPartita),funs(sum(.,na.rm=TRUE)))
Rdribpm <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(DribblingRiuscitiPerPartita),funs(sum(.,na.rm=TRUE)))
Rduelspm <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(DuelliVintiAPartita),funs(sum(.,na.rm=TRUE)))
Rballlose <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(PalloniPersiAPartita),funs(sum(.,na.rm=TRUE)))
Rfauls <- summarise_at(group_by(df,Nazionalità, Ruolo),vars(FalliPerPartita),funs(sum(.,na.rm=TRUE)))
Rage$Anni = trunc(Rage$Anni, prec = -2)
Rheight$Altezza = trunc(Rheight$Altezza, prec = -2) 
```

```{r Assemblo dataframe, include=FALSE}
#Assemblo il dataframe con le medie dei dati delle nazionali
listdf <- list(age, height, homeplayer, awayplayer, ranking, goalscored, goalconceded, assistmade, shootspm, cfailed, touches, ccreated, percpasstot, percpassfr, percpassen,intercpm, contrpm, dribpm, duelspm, balllose, fauls)
df2 <- Reduce(function(x, y) merge(x, y, by="Nazionalità"), listdf)

#Assemblo il dataframe con le medie dei dati per ruolo delle nazionali
listdfR <- list(Rage, Rheight, Rhomeplayer, Rawayplayer, Rranking, Rgoalscored, Rgoalconceded, Rassistmade, Rshootspm, Rcfailed, Rtouches, Rccreated, Rpercpasstot, Rpercpassfr, Rpercpassen,Rintercpm, Rcontrpm, Rdribpm, Rduelspm, Rballlose, Rfauls)
dfR <- Reduce(function(x, y) merge(x, y, by=c("Nazionalità", "Ruolo")), listdfR)
dfR  <- dfR  %>%
  mutate(TiriTotali = TiriPerPartita * PartiteGiocate)
```

```{r Assemblo il dataframe delle nazionali e aggiusto qualche feature, include=FALSE}
#Converto in stringhe il numero di partite giocate 
#in modo da agevolare la visualizzazione nei grafici successivamente
df$PartiteGiocate <- as.character(df$PartiteGiocate)
df$PartiteGiocate[df$PartiteGiocate <= "3"] <- "Gironi"
df$PartiteGiocate[df$PartiteGiocate == "4"] <- "Ottavi di finale"
df$PartiteGiocate[df$PartiteGiocate == "5"] <- "Quarti di finale"
df$PartiteGiocate[df$PartiteGiocate == "6"] <- "Semifinale"
df$PartiteGiocate[df$PartiteGiocate == "7"] <- "Finale"

#Do un ordine di importanza alle stringhe contenute nella feature partite giocate
#in modo da poter rappresentare nei grafici le fasi del toreno raggiunte dalle 
#varie squadre nell'odrine corretto
df$PartiteGiocate <- factor(df$PartiteGiocate, 
                             levels = c("Gironi", "Ottavi di finale", 
                                        "Quarti di finale", "Semifinale", "Finale"))

#Converto in stringhe il numero di partite giocate 
#in modo da agevolare la visualizzazione nei grafici successivamente
df2$PartiteGiocate <- as.character(df2$PartiteGiocate)
df2$PartiteGiocate[df2$PartiteGiocate <= "3"] <- "Gironi"
df2$PartiteGiocate[df2$PartiteGiocate == "4"] <- "Ottavi di finale"
df2$PartiteGiocate[df2$PartiteGiocate == "5"] <- "Quarti di finale"
df2$PartiteGiocate[df2$PartiteGiocate == "6"] <- "Semifinale"
df2$PartiteGiocate[df2$PartiteGiocate == "7"] <- "Finale"

#Do un ordine di importanza alle stringhe contenute nella feature partite giocate
#in modo da poter rappresentare nei grafici le fasi del toreno raggiunte dalle 
#varie squadre nell'odrine corretto
df2$PartiteGiocate <- factor(df2$PartiteGiocate, 
                             levels = c("Gironi", "Ottavi di finale", 
                                        "Quarti di finale", "Semifinale", "Finale"))

#Aggiungo la feature della differenza reti media 
df2 <- mutate(df2,
              GoalDifference = GoalFatti - GoalSubiti)
df2 <- mutate(df2,
              GiocatoriUsati = GiocatoriACasa + GiocatoriAllEstero)
df2a <- df2
```

```{r Creo dataframe con dati medi per ruolo, include=FALSE}
#Converto in stringhe il numero di partite giocate 
#in modo da agevolare la visualizzazione nei grafici successivamente
dfR$PartiteGiocate <- as.character(dfR$PartiteGiocate)
dfR$PartiteGiocate[dfR$PartiteGiocate <= "3"] <- "Gironi"
dfR$PartiteGiocate[dfR$PartiteGiocate == "4"] <- "Ottavi di finale"
dfR$PartiteGiocate[dfR$PartiteGiocate == "5"] <- "Quarti di finale"
dfR$PartiteGiocate[dfR$PartiteGiocate == "6"] <- "Semifinale"
dfR$PartiteGiocate[dfR$PartiteGiocate == "7"] <- "Finale"
dfR$PartiteGiocate <- factor(dfR$PartiteGiocate, 
                             levels = c("Gironi", "Ottavi di finale", 
                                        "Quarti di finale", "Semifinale", "Finale"))

#Creo un sotto-dataframe contenente solamente i giocatori di muovimento 
dfRmuovimento <- filter(dfR, Ruolo == "Difensore" |
                 Ruolo == "Centrocampista" |
                 Ruolo == "Attaccante")

#Aggiungo la feature dei goal segnati a partita
dfRmuovimento <- dfRmuovimento %>%
  mutate (GoalPerPartita = GoalFatti / PartiteGiocate)

#Creo i dataframe contenenti i vari ruoli:
#Creo il dataframe contenente i difensori
DefdfR <- filter(dfR, Ruolo == "Difensore")
#Creo il dataframe contenente i centrocampisti
CendfR <- filter(dfR, Ruolo == "Centrocampista")
#Creo il dataframe contenente gli attaccanti
AttdfR <- filter(dfR, Ruolo == "Attaccante")
```

```{r Creo dataframe con giocatori in quel ruolo, include=FALSE}
#Creo i dataframe contenente i giocatori delle nazionali in un determinato ruolo:

#Dataframe portieri
Goalkeeper <- subset(df, select = -c( Campionato, Nazionecampionato, Squadra, GoalFatti, AssistFatti, TiriPerPartita, GrandiOccasioniSbagliate, OccasioniChiaveCreate, IntercettazioniAPartita, ContrastiAPartita, DribblingRiuscitiPerPartita, DuelliVintiAPartita, Fuorigiochi), MinutiAPartita > 15)
Goalkeeper <- filter(Goalkeeper,  Ruolo == "Portiere")
#Dataframe difensori
Defenders <- subset(df, select = -c( Ruolo, Campionato, Nazionecampionato, Squadra, GoalConcessiPerPartita, ParatePerPartita, RigoriParati, GoalSubiti), Ruolo == "Difensore")
Defenders <- filter(Defenders, MinutiAPartita > 15)

#Dataframe centrocampisti
Midfielders <- subset(df, select = -c( Ruolo, Campionato, Nazionecampionato, Squadra, GoalConcessiPerPartita, ParatePerPartita, RigoriParati, GoalSubiti), Ruolo == "Centrocampista" )
Midfielders <- filter(Midfielders, MinutiAPartita > 15)

#Dataframe attaccanti
Forwards <- subset(df, select = -c( Ruolo, Campionato, Nazionecampionato, Squadra, GoalConcessiPerPartita, ParatePerPartita, RigoriParati, GoalSubiti), Ruolo == "Attaccante" )
Forwards <- filter(Forwards, MinutiAPartita > 15 )
```


## Migliore differenza reti?  {.flexbox .vcenter}

```{r Grafico per differenza reti, echo=FALSE}
p0 <- ggplot(data=df2, 
             aes(x = GoalDifference, y = reorder(Nazionalità,GoalDifference),
                 fill = PartiteGiocate)) +
  geom_bar(stat = "identity") +
  theme_solarized() +
  theme (axis.title = element_text(), 
         plot.caption = element_text(face = "italic"))  +
  scale_fill_brewer(palette="Spectral")+
  labs(x= "Differenza reti", y = "Nazionali", title = "Differenza reti", caption = "Data source: SofaScore") 

p0
```



## Tanto possesso palla = tanti goal? {.flexbox .vcenter}


```{r Palloni toccati vs Goal Fatti, echo=FALSE, warning=FALSE}

p1 <- ggplot(data = df2, mapping = aes(x = PalloniToccatiPerPartita, y = GoalFatti, color = PartiteGiocate)) + 
  geom_point() +
  geom_text_repel(aes(label = Nazionalità), size = 3,  max.overlaps = Inf) +
  theme_fivethirtyeight() +
  theme (axis.title = element_text(), 
         plot.caption = element_text(face = "italic")) +
  labs(x= "Palloni toccati a partita", y = "Goal segnati a partita", caption = "Data source: SofaScore") 

p1
```


## Quanto conta avere un possesso di qualità? {.flexbox .vcenter}


```{r Palloni toccati vs Precisione passaggi, echo=FALSE, warning=FALSE}

p3 <- ggplot(data = df2, mapping = aes(x = PalloniToccatiPerPartita, y = PrecisionePassaggi, color = PartiteGiocate)) + 
  geom_point() +
  geom_text_repel(aes(label = Nazionalità), size = 3,  max.overlaps = Inf) +
  theme_fivethirtyeight() +
  theme (axis.title = element_text(),
         plot.caption = element_text(face = "italic")) +
  labs(x= "Palloni toccati a partita", y = "Precisione passaggi", caption = "Data source: SofaScore") 

p3
```


## Come hanno gestito il possesso le varie nazionali? {.flexbox .vcenter}

```{r Possesso palla vs precisione passaggi, echo=FALSE}
# filter dataframe to get data to be highlighted
highlight_dfR2 <- dfRmuovimento %>% 
             filter(Nazionalità == 'Italia')

pp <- ggplot(dfRmuovimento,aes(x = PalloniToccatiPerPartita, y = PrecisionePassaggi, color = PartiteGiocate)) +
  geom_point() +
  geom_point(data=highlight_dfR2, 
             aes(x=PalloniToccatiPerPartita,y=PrecisionePassaggi), 
             color='red',
             shape = 17,
             size=3) + 
             theme_solarized() +
  theme (axis.title = element_text(),
       plot.caption = element_text(face = "italic")) +
  facet_grid(~Ruolo) +
  labs(x = "Palloni toccati per partita", y = "Precisione passaggi", caption = "Data source : Sofascore")

pp
```


## Nella propria meta campo ... {.flexbox .vcenter}

```{r echo=FALSE}
ppcam <- ggplot(dfRmuovimento,aes(x = PalloniToccatiPerPartita, y = PrecisionePassaggiCampoAmico, color = PartiteGiocate)) +
  geom_point() +
  geom_point(data=highlight_dfR2, 
             aes(x=PalloniToccatiPerPartita,y=PrecisionePassaggiCampoAmico), 
             color='red',
             shape = 17,
             size=3) +
  theme_solarized() +
  theme (axis.title = element_text(),
       plot.caption = element_text(face = "italic")) +
  facet_grid(~Ruolo) +
  labs(x = "Palloni toccati per partita", y = "Precisione passaggi", caption = "Data source : Sofascore")
ppcam
```


## ... e nella metà campo avversaria? {.flexbox .vcenter}


```{r echo=FALSE}
ppcav <- ggplot(dfRmuovimento,aes(x = PalloniToccatiPerPartita, y = PrecisionePassaggiCampoAvversario, color = PartiteGiocate)) +
  geom_point() +
  geom_point(data=highlight_dfR2, 
             aes(x=PalloniToccatiPerPartita,y=PrecisionePassaggiCampoAvversario), 
             color='red',
             shape = 17,
             size=3) +
  theme_solarized() +
  theme (axis.title = element_text(),
       plot.caption = element_text(face = "italic")) +
  facet_grid(~Ruolo) +
  labs(x = "Palloni toccati per partita", y = "Precisione passaggi", caption = "Data source : Sofascore")

ppcav
```


## Chi ha raccolto meno di quanto creato? {.flexbox .vcenter}


```{r Grafico occasioni create vs sfruttate, echo=FALSE}
df2 <- mutate(df2, GoalPossibili = GoalFatti + GrandiOccasioniSbagliate)
p2 <- ggplot(df2) +
  geom_segment( aes(x = reorder(Nazionalità, -GoalFatti), xend = reorder(Nazionalità, -GoalFatti), y=GoalFatti, yend=GoalPossibili), color="grey") +
  geom_point( aes(x=Nazionalità, y=GoalFatti, colour="Sfruttate"), size=3 ) +
  geom_point( aes(x=Nazionalità, y=GoalPossibili, colour= "Potenziali"), size=3 ) +
  coord_flip()+ 
  theme_solarized()  + 
  labs(x= "Nazione", y = "N° di occasioni create vs goal segnati", caption = "Data source: Sofascore") +
  theme(legend.title=element_text(size=20),
       legend.text=element_text(size=14),
       plot.caption = element_text(face = "italic"))+
  scale_colour_manual(name="Occasioni:",
      values=c("Sfruttate" = "seagreen2", "Potenziali" = "indianred3"))
p2
```


## Quale reparto ha contribuito con più goal? {.flexbox .vcenter}

```{r Goal per ruolo nelle top 5, echo=FALSE}
top5goalfatti <- filter(dfRmuovimento,
                        Nazionalità == "Danimarca" | Nazionalità == "Italia" |
                        Nazionalità == "Inghilterra" | Nazionalità == "Spagna" |
                        Nazionalità == "Belgio")
top5goalfatti$Nazionalità <- factor(top5goalfatti$Nazionalità,    
                         levels = c("Danimarca", "Italia", "Inghilterra", "Spagna", "Belgio"))
gf <- ggplot(top5goalfatti, aes(x = "", y = GoalFatti, fill = Ruolo)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  theme_fivethirtyeight() +
  theme(axis.text.y=element_blank(), 
                axis.ticks=element_blank(), 
                axis.title=element_blank(),
                panel.border = element_blank()) +
  facet_grid(.~ Nazionalità) +
  labs(caption = "Data source: Sofascore")
gf
```

## Dribblare è essenziale per segnare? {.flexbox .vcenter}


```{r Dribbling Riusciti vs Goal fatti, echo=FALSE, warning=FALSE}

p4 <- ggplot(data = df2, mapping = aes(x = DribblingRiuscitiPerPartita, y = GoalFatti, color = PartiteGiocate)) + 
  geom_point() +
  geom_text_repel(aes(label = Nazionalità), size = 3,  max.overlaps = Inf) +
  theme_fivethirtyeight() +
  theme (axis.title = element_text(),
         plot.caption = element_text(face = "italic")) +
  labs(x= "Dribbling riusciti a partita", y = "Goal Fatti", caption = "Data source : Sofascore") 

p4
```


